------------------------------------------------------------
-- Copyright (c) 2020 by Paul Scherrer Institute, Switzerland
-- All rights reserved.
------------------------------------------------------------

------------------------------------------------------------
-- Testbench generated by TbGen.py
------------------------------------------------------------
-- see Library/Python/TbGenerator

------------------------------------------------------------
-- Libraries
------------------------------------------------------------
library ieee;
	use ieee.std_logic_1164.all;
	use ieee.numeric_std.all;

library work;
	use work.psi_fix_pkg.all;
	use work.psi_tb_compare_pkg.all;

------------------------------------------------------------
-- Entity Declaration
------------------------------------------------------------
entity psi_fix_resize_tb is
end entity;

------------------------------------------------------------
-- Architecture
------------------------------------------------------------
architecture sim of psi_fix_resize_tb is
	-- *** Fixed Generics ***
	constant InFmt_g : psi_fix_fmt_t := (1,1,14);
	constant OutFmt_g : psi_fix_fmt_t := (0,0,3);
	constant Round_g : psi_fix_rnd_t := PsiFixRound;
	constant Sat_g : psi_fix_sat_t := PsiFixSat;
	
	-- *** Not Assigned Generics (default values) ***
	
	-- *** TB Control ***
	signal TbRunning : boolean := True;
	signal NextCase : integer := -1;
	signal ProcessDone : std_logic_vector(0 to 1) := (others => '0');
	constant AllProcessesDone_c : std_logic_vector(0 to 1) := (others => '1');
	constant TbProcNr_stim_c : integer := 0;
	constant TbProcNr_resp_c : integer := 1;
	
	-- *** DUT Signals ***
	signal Clk : std_logic := '1';
	signal Rst : std_logic := '1';
	signal InVld : std_logic := '0';
	signal InRdy : std_logic := '1';
	signal InData : std_logic_vector(PsiFixSize(InFmt_g)-1 downto 0) := (others => '0');
	signal OutVld : std_logic := '0';
	signal OutRdy : std_logic := '0';
	signal OutData : std_logic_vector(PsiFixSize(OutFmt_g)-1 downto 0) := (others => '0');
	
begin
	------------------------------------------------------------
	-- DUT Instantiation
	------------------------------------------------------------
	i_dut : entity work.psi_fix_resize
		generic map (
			InFmt_g => InFmt_g,
			OutFmt_g => OutFmt_g,
			Round_g => Round_g,
			Sat_g => Sat_g
		)
		port map (
			clk_i => Clk,
			rst_i => Rst,
			vld_i => InVld,
			rdy_o => InRdy,
			dat_i => InData,
			vld_o => OutVld,
			rdy_i => OutRdy,
			dat_o => OutData
		);
	
	------------------------------------------------------------
	-- Testbench Control !DO NOT EDIT!
	------------------------------------------------------------
	p_tb_control : process
	begin
		wait until Rst = '0';
		wait until ProcessDone = AllProcessesDone_c;
		TbRunning <= false;
		wait;
	end process;
	
	------------------------------------------------------------
	-- Clocks !DO NOT EDIT!
	------------------------------------------------------------
	p_clock_Clk : process
		constant Frequency_c : real := real(100e6);
	begin
		while TbRunning loop
			wait for 0.5*(1 sec)/Frequency_c;
			Clk <= not Clk;
		end loop;
		wait;
	end process;
	
	
	------------------------------------------------------------
	-- Resets
	------------------------------------------------------------
	p_rst_Rst : process
	begin
		wait for 1 us;
		-- Wait for two clk edges to ensure reset is active for at least one edge
		wait until rising_edge(Clk);
		wait until rising_edge(Clk);
		Rst <= '0';
		wait;
	end process;
	
	
	------------------------------------------------------------
	-- Processes
	------------------------------------------------------------
	-- *** stim ***
	p_stim : process
	begin
		-- start of process !DO NOT EDIT
		wait until Rst = '0';
		wait until rising_edge(Clk);
		
		-- Test no saturation/no rounding
		InVld <= '1';
		InData <= PsiFixFromReal(0.5, InFmt_g);
		wait until rising_edge(Clk) and InRdy = '1';
		
		InData <= PsiFixFromReal(0.25, InFmt_g);
		wait until rising_edge(Clk) and InRdy = '1';
		
		InData <= PsiFixFromReal(0.75, InFmt_g);
		wait until rising_edge(Clk) and InRdy = '1';
		
		-- Test Rounding
		InData <= PsiFixFromReal(0.47, InFmt_g);
		wait until rising_edge(Clk) and InRdy = '1';
		
		InData <= PsiFixFromReal(0.53, InFmt_g);
		wait until rising_edge(Clk) and InRdy = '1';	

		-- Test Saturation
		InData <= PsiFixFromReal(1.8, InFmt_g);
		wait until rising_edge(Clk) and InRdy = '1';		
		
		InData <= PsiFixFromReal(-0.5, InFmt_g);
		wait until rising_edge(Clk) and InRdy = '1';

		-- Last check to see if normal numbers still pass
		InData <= PsiFixFromReal(0.5, InFmt_g);
		wait until rising_edge(Clk) and InRdy = '1';
		InVld <= '0';
		
		
		-- end of process !DO NOT EDIT!
		ProcessDone(TbProcNr_stim_c) <= '1';
		wait;
	end process;
	
	-- *** resp ***
	p_resp : process
	begin
		-- start of process !DO NOT EDIT
		wait until Rst = '0';
		
		-- Test no saturation/no rounding
		OutRdy <= '1';
		
		wait until rising_edge(Clk) and OutVld = '1';
		StdlvCompareStdlv(PsiFixFromReal(0.5, OutFmt_g), OutData, "Data0");

		wait until rising_edge(Clk) and OutVld = '1';
		StdlvCompareStdlv(PsiFixFromReal(0.25, OutFmt_g), OutData, "Data1");
		
		-- Test Back Pressure
		OutRdy <= '0';
		for i in 0 to 9 loop
			wait until rising_edge(Clk);
		end loop;
		OutRdy <= '1';
		
		wait until rising_edge(Clk) and OutVld = '1';
		StdlvCompareStdlv(PsiFixFromReal(0.75, OutFmt_g), OutData, "Data2");
		
		-- Test Rounding
		wait until rising_edge(Clk) and OutVld = '1';
		StdlvCompareStdlv(PsiFixFromReal(0.5, OutFmt_g), OutData, "Data3");
		
		wait until rising_edge(Clk) and OutVld = '1';
		StdlvCompareStdlv(PsiFixFromReal(0.5, OutFmt_g), OutData, "Data4");

		-- Test Saturation
		wait until rising_edge(Clk) and OutVld = '1';
		StdlvCompareStdlv(PsiFixFromReal(1.0-1.0/8.0, OutFmt_g), OutData, "Data5");		
		
		wait until rising_edge(Clk) and OutVld = '1';
		StdlvCompareStdlv(PsiFixFromReal(0.0, OutFmt_g), OutData, "Data6");

		-- Last check to see if normal numbers still pass
		wait until rising_edge(Clk) and OutVld = '1';
		StdlvCompareStdlv(PsiFixFromReal(0.5, OutFmt_g), OutData, "Data7");
		
		
		-- end of process !DO NOT EDIT!
		ProcessDone(TbProcNr_resp_c) <= '1';
		wait;
	end process;
	
	
end;
